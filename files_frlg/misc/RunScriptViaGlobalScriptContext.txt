@@ title = "Run script via GlobalScriptContext"
@@ author = "final and Mettrich"
@@ exit = "ROM_BX_lr_Box10_Grab"
@@ filler4 = 0xffffffff

// This code inserts a custom script pointer into the global script
// context (and also sets some other stuff) that will run as soon as
// you return to the overworld.
//
// Script addresses from "Run script via NPC" should work here.
//
// Trigger ACE, then return to the overworld. The script should run
// immediately.

script_address = 0x0

@@

; `ctx` refers to sGlobalScriptContext

MOV     r10, #0x3000000                 ; IWRAM addressing

MOV     r11, #0xbd00
BIC     r11, r11, #0x3fc00              ; r11 = 0x100, mode=SCRIPT_MODE_BYTECODE, stackDepth=0

STRB    r11, [r10, #0xea8]!             ; Store CONTEXT_RUNNING in sGlobalScriptContextStatus

STRH    r11, [r10, #8]!                 ; Store in ctx->stackDepth, and ctx->mode

MOV     r12, #{script_address} ?
STR     r12, [r10, r11, ASR #5]!        ; Store in ctx->scriptPtr (r10 + 8)
