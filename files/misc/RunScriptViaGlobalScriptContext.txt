@@ title = "Run script via GlobalScriptContext"
@@ author = "final and Mettrich"
@@ exit = "ROM_BX_lr_Box10_Sprite"
@@ filler4 = 0xffffffff

// The default exit code set for this code will leave you on the summary
// screen.
//
// For metastable species such as 0x40ed, 0x415e, or 0x599, make sure that
// you view the summary of an adjacent Pokémon, switch to the statistics,
// moves, or contest moves page, then switch to the ACE species’ summary.
//
// Alternatively you can also use a different exit code such as
// "Certificate" or "Bootstrapped" (with a Certificate exit bootstrap)
// instead.

// This code inserts a custom script pointer into the global script
// context (and also sets some other stuff) that will run as soon as
// you return to the overworld.
//
// Script addresses from "Change ObjectEvent Script Pointer" should work here.
//
// Trigger ACE, then return to the overworld. The script should run
// immediately.

script_address = 0x0

@@

; `ctx` refers to sGlobalScriptContext

MOV     r10, #0x3000000                 ; IWRAM addressing part 1
SBCGT   r10, r10, r10, ASR #17          ; r10 = 0x2fffe7f, address part 2
BIC     r10, r10, #0xfc000003           ; r10 = 0x2fffe7c, address part 3

ADC     r12, r10, #0x284                ; r12 = 0x3000100, mode=SCRIPT_MODE_BYTECODE, stackDepth=0

STRB    r12, [r10, #0xfbc]!             ; Store CONTEXT_RUNNING in sGlobalScriptContextStatus

STRH    r12, [r10, #8]                  ; Store in ctx->stackDepth, and ctx->mode

MOV     r12, #{script_address} ?
STR     r12, [r10, r14, ASR #23]!       ; Store in ctx->scriptPtr (r10 + 16)
